!function(e){function o(r){if(n[r])return n[r].exports;var t=n[r]={i:r,l:!1,exports:{}};return e[r].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var n={};o.m=e,o.c=n,o.d=function(e,n,r){o.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},o.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(n,"a",n),n},o.o=function(e,o){return Object.prototype.hasOwnProperty.call(e,o)},o.p="",o(o.s=9)}([function(e,o){e.exports=require("dotenv")},function(e,o){e.exports=require("mongoose")},function(e,o,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(o,"__esModule",{value:!0}),o.purgeUserBooks=o.changeBookOwner=o.removeBook=o.saveBook=o.denyRequest=o.approveRequest=o.cancelRequest=o.requestBook=o.sternGaze=o.curseOfAlexandria=o.otherShelves=o.userShelves=o.library=void 0;var t=n(0),s=r(t),u=n(5),a=r(u);s.default.load();o.library=function(e,o){a.default.find({},function(e,n){e&&console.error(e),n&&o.json(n)})},o.userShelves=function(e,o){var n=e.params.user;a.default.find({owner:n},function(e,n){e&&console.error(e),n?o.json(n):o.json("Nope, nothing")})},o.otherShelves=function(e,o){var n=e.params.user;a.default.find({owner:{$ne:n}},function(e,n){e&&console.error(e),n?o.json(n):o.json("Nope, you own the whole library.")})},o.curseOfAlexandria=function(e,o){a.default.remove({},function(e,n){console.log("All books deleted..."),o.json("All books deleted...")})},o.sternGaze=function(e,o){o.on(e,function(e){setInterval(function(){a.default.find({},function(e,n){o.emit(n)})},e)})},o.requestBook=function(e,o){var n=e.params.user,r=JSON.parse(decodeURIComponent(e.params.data));a.default.findOneAndUpdate({olkey:r.olkey},{requested:!0,requestor:n},function(e,n){e&&console.error(e),n&&o.json("Book requested.")})},o.cancelRequest=function(e,o){var n=e.params.user,r=JSON.parse(decodeURIComponent(e.params.data));a.default.findOneAndUpdate({olkey:r.olkey,requestor:n,requested:!0},{requested:!1,requestor:""},function(e,n){e&&console.error(e),n&&o.json("Request for book with olkey "+r.olkey+" canceled.")})},o.approveRequest=function(e,o){var n=e.params.user,r=JSON.parse(decodeURIComponent(e.params.data));a.default.findOne({olkey:r.olkey,owner:n,requested:!0},function(e,n){e&&console.error(e),n&&(console.log("Before",n),n.owner=n.requestor,n.requestor="",n.requested=!1,console.log("After",n),n.save(function(e,n){console.log("Saved",n),o.json("You have successfully swapped a book!")}))})},o.denyRequest=function(e,o){var n=e.params.user,r=JSON.parse(decodeURIComponent(e.params.data));a.default.findOneAndUpdate({olkey:r.olkey,owner:n,requested:!0},{requested:!1,requestor:""},function(e,n){e&&console.error(e),n&&o.json("Request for book with olkey "+r.olkey+" denied.")})},o.saveBook=function(e,o){var n=e.params.user,r=JSON.parse(decodeURIComponent(e.params.data));a.default.findOne({username:n,olkey:r.olkey},function(e,t){if(e&&console.error(e),t)o.json("This book is already in the database.");else{new a.default({author:r.author,title:r.title,publication:r.publication,cover:r.cover,olkey:r.olkey,owner:n}).save(function(e,n){e&&console.error(e),o.json("This book has been saved to your collection.")})}})},o.removeBook=function(e,o){var n=e.params.user,r=JSON.parse(decodeURIComponent(e.params.data));console.log(r),a.default.remove({owner:n,olkey:r.olkey},function(e,n){e&&console.error(e),n&&o.json(n+" has been deleted.")})},o.changeBookOwner=function(e,o){a.default.find({},function(n,r){n&&console.error(n),r&&r.map(function(n){n.owner===e&&(n.owner=o),n.requestor===e&&!0===n.requested&&(n.requestor=o),n.save(function(e,o){e&&console.error(e)})})})},o.purgeUserBooks=function(e){a.default.find({},function(o,n){o&&console.error(o),n&&n.map(function(o){o.requestor===e&&(o.requested=!1,o.requestor=""),o.owner===e&&!0===o.requested&&(o.requested=!1,o.requestor=""),o.save(function(e,o){e&&console.error(e)})})}),a.default.remove({owner:e},function(e,o){e&&console.error(e)})}},function(e,o){e.exports=require("babel-polyfill")},function(e,o){e.exports=require("passport")},function(e,o,n){"use strict";Object.defineProperty(o,"__esModule",{value:!0});var r=n(1),t=function(e){return e&&e.__esModule?e:{default:e}}(r),s=t.default.Schema,u=new s({author:String,cover:String,olkey:String,owner:String,publication:Number,requested:{default:!1,type:Boolean},requestor:String,title:String});o.default=t.default.model("Book",u)},function(e,o,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(o,"__esModule",{value:!0}),o.authConfig=void 0;var t=n(7),s=r(t),u=n(4),a=(r(u),n(21)),i=n(8),l=r(i);o.authConfig=function(e){e.use(new a.Strategy(function(e,o,n){s.default.findOne({username:e},function(e,r){return e?n(e):r?void l.default.compare(o,r.password,function(e,o){return o?n(null,r):(console.log("Bad password"),n(null,!1))}):(console.log("No such user exists."),n(null,!1))})})),e.serializeUser(function(e,o){o(null,e.id)}),e.deserializeUser(function(e,o){s.default.findById(e,function(e,n){o(e,n)})})}},function(e,o,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(o,"__esModule",{value:!0});var t=n(20),s=r(t),u=n(1),a=r(u),i=a.default.Schema,l=new i({created:{type:Date,required:!0,default:new Date},location:{match:s.default.location.regex,minlength:1,required:!0,type:String},password:{match:s.default.password.regex,minlength:8,required:!0,type:String},username:{index:{unique:!0},match:s.default.username.regex,minlength:1,required:!0,type:String}});o.default=a.default.model("User",l)},function(e,o){e.exports=require("bcrypt")},function(e,o,n){n(3),e.exports=n(10)},function(e,o,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}n(3);var t=n(11),s=r(t);n(12);var u=n(13),a=r(u),i=n(0),l=r(i),c=n(14),d=r(c),f=n(15),p=r(f),v=n(1),m=r(v),h=n(16),g=r(h),y=n(4),q=r(y),w=n(17),b=r(w),O=n(18),k=r(O),_=n(19),j=n(6),x=n(25),S=r(x),U=n(26),R=r(U),P=n(27),N=r(P);s.default.polyfill();var B=(0,a.default)(),A=process.cwd();l.default.load();B.use((0,d.default)("tiny")),B.use((0,p.default)()),B.use("/js",a.default.static(A+"/dist/js")),B.use("/styles",a.default.static(A+"/dist/styles")),B.use("/img",a.default.static(A+"/dist/img"));var M=m.default.connection;m.default.Promise=s.default,m.default.connect(process.env.MONGO_URI,{useMongoClient:!0},function(e,o){e?console.error("Failed to connect to database!"):console.log("Connected to database.")});var C=n(28)(g.default);B.use(b.default.urlencoded({extended:!1})),B.use((0,k.default)());var I={secret:process.env.SECRET,resave:!1,saveUninitialized:!1,cookie:{path:"/",httpOnly:!1,maxAge:18e5},store:new C({mongooseConnection:M},function(e){console.log(e)}),name:"id"};B.set("trust proxy",1),I.cookie.secure=!0,I.cookie.httpOnly=!0,B.use((0,g.default)(I)),B.use(q.default.initialize()),B.use(q.default.session()),(0,j.authConfig)(q.default),(0,_.routes)(B,q.default);var z=S.default.createServer(B),J=(0,R.default)(z);(0,N.default)(J);var T=process.env.PORT;z.listen(T,function(){console.log("Server is listening on port",T+".")})},function(e,o){e.exports=require("es6-promise")},function(e,o){e.exports=require("isomorphic-fetch")},function(e,o){e.exports=require("express")},function(e,o){e.exports=require("morgan")},function(e,o){e.exports=require("compression")},function(e,o){e.exports=require("express-session")},function(e,o){e.exports=require("body-parser")},function(e,o){e.exports=require("cookie-parser")},function(e,o,n){"use strict";Object.defineProperty(o,"__esModule",{value:!0}),o.routes=void 0;var r=n(0),t=function(e){return e&&e.__esModule?e:{default:e}}(r),s=n(2),u=(n(6),n(22)),a=n(23),i=process.cwd();t.default.load();o.routes=function(e,o){e.use("*",function(e,o,n){"https"!==e.headers["x-forwarded-proto"]?(console.log("Redirecting to",process.env.APP_URL+e.url),o.redirect(process.env.APP_URL+e.url)):n()}),e.route("/welcome/jsValidate/:data").post(u.jsValidate),e.route("/welcome").get(function(e,o){o.sendFile(i+"/dist/welcome.html")}).post(o.authenticate("local",{successRedirect:"/",failureRedirect:"/welcome"}));var n=void 0,r=function(e,o,r){if(e.isAuthenticated())return n=e.user.username,r();o.redirect("/welcome")};e.route("/").get(r,function(e,o){o.sendFile(i+"/dist/index.html")}),e.route("/logout").get(r,function(e,o){e.logout(),o.redirect("/welcome")}),e.route("/api/search/:s").post(a.searchSubmit),e.route("/api/:user/request/:data").post(s.requestBook),e.route("/api/:user/cancelRequest/:data").post(s.cancelRequest),e.route("/api/:user/denyRequest/:data").post(s.denyRequest),e.route("/api/:user/approveRequest/:data").post(s.approveRequest),e.route("/api/:user/update-profile/:data").post(u.updateProfile),e.route("/api/:user/update-password/:data").post(u.updatePassword),e.route("/api/:user/save/:data").post(s.saveBook).delete(s.removeBook),e.route("/api/:user/userBooks").get(s.userShelves),e.route("/api/:user/otherBooks").get(s.otherShelves),e.route("/api/users").get(u.viewUsers).post(u.saveUser,o.authenticate("local",{successRedirect:"/",failureRedirect:"/welcome"})),e.route("/api/users/logged").get(function(e,o){o.json(n)}),e.route("/api/:user/location").get(u.getLocation),e.route("/api/deleteUser/:user").delete(u.deleteUser)}},function(e,o,n){"use strict";Object.defineProperty(o,"__esModule",{value:!0});var r={location:{err:"Please use 1-100 letters. Don't include your street address or other personal information.",hint:"City and state or province",label:"Location",regex:/^[a-zA-Z\,\-\.\ ]{1,100}$/},password:{err:{description:"Your password must include at least 8 letters, numbers, and special characters.",vague:"Something went wrong. Please try again."},label:{first:"Create a password",change:""},hint:"Use at least 8 letters, numbers, and special characters.",regex:/(?=.*[a-zA-Z]+)(?=.*[0-9]+)(?=.*[^a-zA-Z0-9]+).{8,}/},username:{err:{first:"Please use 1-40 letters and numbers.",used:"This username is already in use. Please choose another one."},label:"Choose your username",hint:"Your username will be public.",regex:/^[A-Za-z0-9\-\.\,\ ]{1,40}$/}};o.default=r},function(e,o){e.exports=require("passport-local")},function(e,o,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(o,"__esModule",{value:!0}),o.deleteUser=o.updatePassword=o.updateProfile=o.saveUser=o.getLocation=o.jsValidate=o.genocide=o.viewUsers=void 0;var t=n(0),s=r(t),u=n(7),a=r(u),i=n(8),l=r(i),c=n(2);s.default.load();o.viewUsers=function(e,o){a.default.find({},function(e,n){e&&console.error(e),n&&o.json(n)})},o.genocide=function(e,o){a.default.remove({},function(e,n){e&&console.error(e),n&&(console.log("All users deleted..."),o.json("All users deleted..."))})},o.jsValidate=function(e,o){var n=JSON.parse(decodeURIComponent(e.params.data)),r=n.username,t=n.password;a.default.findOne({username:r},function(e,n){e&&console.error(e),t?n?l.default.compare(t,n.password,function(e,n){n?o.json("OK"):o.json("NO")}):o.json("NO"):n?o.json("NO"):o.json("OK")})},o.getLocation=function(e,o){var n=e.params.user;a.default.findOne({username:n},function(e,n){e&&console.error(e),n&&o.json(n.location)})},o.saveUser=function(e,o,n){var r=e.body;a.default.findOne({username:r.username},function(e,t){e&&console.error(e),t?o.json("NO"):l.default.hash(r.password,10,function(e,o){new a.default({username:r.username,password:o,location:r.location}).save(function(e,o){return e&&console.error(e),console.log(r.username+" successfully signed up. Logging in."),n()})})})},o.updateProfile=function(e,o){var n=e.params.user,r=JSON.parse(decodeURIComponent(e.params.data)),t=void 0;r.username&&a.default.findOne({username:r.username},function(e,o){e&&console.error(e),o?t="NO":a.default.findOneAndUpdate({username:n},{username:r.username},function(e,o){e&&console.error(e),o&&((0,c.changeBookOwner)(n,r.username),t="NO"===t?"NO":"OK",console.log("THIS IS IT:",t))})}),r.location&&a.default.findOneAndUpdate({username:n},{location:r.location},function(e,o){e&&console.error(e),o?(console.log(o),t="NO"===t?"NO":"OK"):t="NO"});var s=setInterval(function(){t&&(o.json(t),clearInterval(s))},500)},o.updatePassword=function(e,o){var n=e.params.user,r=JSON.parse(decodeURIComponent(e.params.data));a.default.findOne({username:n},function(e,n){e&&console.error(e),n?l.default.compare(r.currentPassword,n.password,function(e,t){t?l.default.hash(r.newPassword,10,function(e,r){n.password=r,n.save(function(e,n){e&&console.error(e),o.json("OK")})}):o.json("NO")}):o.json("NO")})},o.deleteUser=function(e,o){var n=e.params.user;(0,c.purgeUserBooks)(n),a.default.remove({username:n},function(e,n){e&&console.error(e),n&&o.json("BYE")})}},function(e,o,n){"use strict";Object.defineProperty(o,"__esModule",{value:!0}),o.searchSubmit=void 0;var r=n(24);o.searchSubmit=function(e,o){(0,r.f)("GET","https://openlibrary.org/search.json?q="+e.params.s,function(e){for(var n=[],r=0;r<20;r++){var t=e.docs[r],s=void 0;s=t.author_name?1===t.author_name.length?t.author_name[0]:2===t.author_name.length?t.author_name.join(" and "):t.author_name.length>2?t.author_name[0]+", "+t.author_name[1]+", et al.":"Unlisted":"Unlisted";var u=void 0;u=t.title?t.title:"Unlisted Title";var a=void 0;a=t.first_publish_year?t.first_publish_year:0;var i=void 0;i=t.cover_edition_key?t.cover_edition_key:null;var l=void 0;t.key&&(l=t.key,l=l.split(""),l.splice(0,7),l=l.join(""));var c={author:s,title:u,publication:a,cover:i,olkey:l};if(c.cover&&n.push(c),r===e.docs.length-1)break}o.json(n)})}},function(e,o,n){"use strict";function r(e){return function(){var o=e.apply(this,arguments);return new Promise(function(e,n){function r(t,s){try{var u=o[t](s),a=u.value}catch(e){return void n(e)}if(!u.done)return Promise.resolve(a).then(function(e){r("next",e)},function(e){r("throw",e)});e(a)}return r("next")})}}Object.defineProperty(o,"__esModule",{value:!0});o.f=function(){var e=r(regeneratorRuntime.mark(function e(o,n,r,t){var s,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch(n,{method:o});case 3:return s=e.sent,e.next=6,s.json();case 6:u=e.sent,r(u),e.next=13;break;case 10:return e.prev=10,e.t0=e.catch(0),e.abrupt("return",e.t0);case 13:return e.prev=13,t&&t(),e.finish(13);case 16:case"end":return e.stop()}},e,void 0,[[0,10,13,16]])}));return function(o,n,r,t){return e.apply(this,arguments)}}(),o.uniq=function(e){return Array.from(new Set(e))}},function(e,o){e.exports=require("http")},function(e,o){e.exports=require("socket.io")},function(e,o,n){"use strict";Object.defineProperty(o,"__esModule",{value:!0});var r=n(5),t=function(e){return e&&e.__esModule?e:{default:e}}(r),s=(n(2),function(e){e.on("connection",function(o){console.log("Web Sockets connected."),o.on("librarian",function(e){setInterval(function(){t.default.find({owner:[e[1]]},function(e,n){e&&console.error(e),n&&o.emit("librarian",[n,null,null,null,null])}),t.default.find({owner:{$ne:[e[1]]},requested:!1},function(e,n){e&&console.error(e),n&&o.emit("librarian",[null,n,null,null,null])}),t.default.find({requested:!0},function(e,n){e&&console.error(e),n&&o.emit("librarian",[null,null,n,null,null])}),t.default.find({requested:!0,requestor:e[1]},function(e,n){e&&console.error(e),n&&o.emit("librarian",[null,null,null,n,null])}),t.default.find({requested:!0,owner:e[1]},function(e,n){e&&console.error(e),n&&o.emit("librarian",[null,null,null,null,n])})},e[0])}),e.on("disconnect",function(){console.log("Web Sockets disconnected.")})})});o.default=s},function(e,o){e.exports=require("connect-mongo")}]);