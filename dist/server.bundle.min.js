!function(e){function o(t){if(n[t])return n[t].exports;var r=n[t]={i:t,l:!1,exports:{}};return e[t].call(r.exports,r,r.exports,o),r.l=!0,r.exports}var n={};o.m=e,o.c=n,o.d=function(e,n,t){o.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:t})},o.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(n,"a",n),n},o.o=function(e,o){return Object.prototype.hasOwnProperty.call(e,o)},o.p="",o(o.s=8)}([function(e,o){e.exports=require("mongoose")},function(e,o){e.exports=require("babel-polyfill")},function(e,o){e.exports=require("passport")},function(e,o,n){"use strict";Object.defineProperty(o,"__esModule",{value:!0}),o.removeBook=o.saveBook=o.denyRequest=o.approveRequest=o.cancelRequest=o.requestBook=o.sternGaze=o.curseOfAlexandria=o.otherShelves=o.userShelves=o.library=void 0;var t=n(4),r=function(e){return e&&e.__esModule?e:{default:e}}(t);o.library=function(e,o){r.default.find({},function(e,n){e&&console.error(e),n&&o.json(n)})},o.userShelves=function(e,o){var n=e.params.user;r.default.find({owner:n},function(e,n){e&&console.error(e),n?o.json(n):o.json("Nope, nothing")})},o.otherShelves=function(e,o){var n=e.params.user;r.default.find({owner:{$ne:n}},function(e,n){e&&console.error(e),n?o.json(n):o.json("Nope, you own the whole library.")})},o.curseOfAlexandria=function(e,o){r.default.remove({},function(e,n){console.log("All books deleted..."),o.json(n)})},o.sternGaze=function(e,o){o.on(e,function(e){setInterval(function(){r.default.find({},function(e,n){o.emit(n)})},e)})},o.requestBook=function(e,o){var n=e.params.user,t=JSON.parse(decodeURIComponent(e.params.data));r.default.findOneAndUpdate({olkey:t.olkey},{requested:!0,requestor:n},function(e,o){e&&console.error(e)})},o.cancelRequest=function(e,o){var n=e.params.user,t=JSON.parse(decodeURIComponent(e.params.data));r.default.findOneAndUpdate({olkey:t.olkey,requestor:n,requested:!0},{requested:!1,requestor:""},function(e,n){e&&console.error(e),n&&o.json("Request for book with olkey "+t.olkey+" cancelled.")})},o.approveRequest=function(e,o){var n=e.params.user,t=JSON.parse(decodeURIComponent(e.params.data));r.default.findOne({olkey:t.olkey,owner:n,requested:!0},function(e,o){e&&console.error(e),o&&(console.log("Before",o),o.owner=o.requestor,o.requestor="",o.requested=!1,console.log("After",o),o.save(function(e,o){console.log("Saved",o)}))})},o.denyRequest=function(e,o){var n=e.params.user,t=JSON.parse(decodeURIComponent(e.params.data));r.default.findOneAndUpdate({olkey:t.olkey,owner:n,requested:!0},{requested:!1,requestor:""},function(e,n){e&&console.error(e),n&&o.json("Request for book with olkey "+t.olkey+" denied.")})},o.saveBook=function(e,o){var n=e.params.user,t=JSON.parse(decodeURIComponent(e.params.data));r.default.findOne({olkey:t.olkey},function(e,u){if(e&&console.error(e),u)o.json("This book is already in the database");else{new r.default({author:t.author,title:t.title,publication:t.publication,cover:t.cover,olkey:t.olkey,owner:n}).save(function(e,t){e&&console.error(e),o.json("This book has been saved! Praise Jesus! It is owned by "+n+"!")})}})},o.removeBook=function(e,o){var n=e.params.user,t=JSON.parse(decodeURIComponent(e.params.data));r.default.remove({owner:n,olkey:t.olkey},function(e,o){e&&console.error(e),o&&console.log(o+" has been deleted.")})}},function(e,o,n){"use strict";Object.defineProperty(o,"__esModule",{value:!0});var t=n(0),r=function(e){return e&&e.__esModule?e:{default:e}}(t),u=r.default.Schema,s=new u({author:String,title:String,publication:Number,cover:String,olkey:String,requested:{type:Boolean,default:!1},owner:String,requestor:String});o.default=r.default.model("Book",s)},function(e,o,n){"use strict";function t(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(o,"__esModule",{value:!0}),o.authConfig=void 0;var r=n(6),u=t(r),s=n(2),a=(t(s),n(20)),i=n(7),l=t(i);o.authConfig=function(e){e.use(new a.Strategy(function(e,o,n){u.default.findOne({username:e},function(e,t){return e?n(e):t?void l.default.compare(o,t.password,function(e,o){return o?n(null,t):(console.log("Bad password"),n(null,!1))}):n(null,!1)})})),e.serializeUser(function(e,o){o(null,e.id)}),e.deserializeUser(function(e,o){u.default.findById(e,function(e,n){o(e,n)})})}},function(e,o,n){"use strict";Object.defineProperty(o,"__esModule",{value:!0});var t=n(0),r=function(e){return e&&e.__esModule?e:{default:e}}(t),u=r.default.Schema,s=new u({username:String,password:{type:String,required:!0},created:{type:Date,required:!0,default:new Date},location:String});o.default=r.default.model("User",s)},function(e,o){e.exports=require("bcrypt")},function(e,o,n){n(1),e.exports=n(9)},function(e,o,n){"use strict";function t(e){return e&&e.__esModule?e:{default:e}}n(1);var r=n(10),u=t(r);n(11);var s=n(12),a=t(s),i=n(13),l=t(i),c=n(14),d=t(c),f=n(15),p=t(f),v=n(0),m=t(v),h=n(16),y=t(h),g=n(2),b=t(g),q=n(17),w=t(q),k=n(18),_=t(k),x=n(19),O=n(5),j=n(24),S=t(j),R=n(25),P=t(R),U=n(26),M=t(U);u.default.polyfill();var B=(0,a.default)(),C=process.cwd();l.default.load();B.use((0,d.default)("tiny")),B.use((0,p.default)()),B.use("/js",a.default.static(C+"/dist/js")),B.use("/styles",a.default.static(C+"/dist/styles")),B.use("/img",a.default.static(C+"/dist/img"));var N=m.default.connection;m.default.Promise=u.default,m.default.connect(process.env.MONGO_URI,{useMongoClient:!0},function(e,o){e?console.error("Failed to connect to database!"):console.log("Connected to database.")});var I=n(27)(y.default);B.use(w.default.urlencoded({extended:!1})),B.use((0,_.default)());var A={secret:process.env.SECRET,resave:!1,saveUninitialized:!1,cookie:{path:"/",httpOnly:!1,maxAge:18e5},store:new I({mongooseConnection:N},function(e){console.log(e)}),name:"id"};B.set("trust proxy",1),A.cookie.secure=!0,A.cookie.httpOnly=!0,B.use((0,y.default)(A)),B.use(b.default.initialize()),B.use(b.default.session()),(0,O.authConfig)(b.default),(0,x.routes)(B,b.default);var J=S.default.createServer(B),T=(0,P.default)(J);(0,M.default)(T);var z=process.env.PORT;J.listen(z,function(){console.log("Server is listening on port",z+".")})},function(e,o){e.exports=require("es6-promise")},function(e,o){e.exports=require("isomorphic-fetch")},function(e,o){e.exports=require("express")},function(e,o){e.exports=require("dotenv")},function(e,o){e.exports=require("morgan")},function(e,o){e.exports=require("compression")},function(e,o){e.exports=require("express-session")},function(e,o){e.exports=require("body-parser")},function(e,o){e.exports=require("cookie-parser")},function(e,o,n){"use strict";Object.defineProperty(o,"__esModule",{value:!0}),o.routes=void 0;var t=n(3),r=(n(5),n(21)),u=n(22),s=process.cwd();o.routes=function(e,o){var n=void 0,a=function(e,o,t){if(e.isAuthenticated())return n=e.user.username,t();o.redirect("/welcome")};e.route("/welcome").get(function(e,o){o.sendFile(s+"/dist/welcome.html")}).post(o.authenticate("local",{successRedirect:"/",failureRedirect:"/welcome"})),e.route("/").get(a,function(e,o){o.sendFile(s+"/dist/index.html")}),e.route("/logout").get(a,function(e,o){e.logout(),o.redirect("/welcome")}),e.route("/api/search/:s").post(u.searchSubmit),e.route("/api/:user/request/:data").post(t.requestBook),e.route("/api/:user/cancelRequest/:data").post(t.cancelRequest),e.route("/api/:user/denyRequest/:data").post(t.denyRequest),e.route("/api/:user/approveRequest/:data").post(t.approveRequest),e.route("/api/:user/profile-update/:data").post(r.updateProfile),e.route("/api/:user/update-password/:data").post(r.updatePassword),e.route("/api/:user/save/:data").post(t.saveBook).delete(t.removeBook),e.route("/api/:user/userBooks").get(t.userShelves),e.route("/api/:user/otherBooks").get(t.otherShelves),e.route("/api/users").get(r.viewUsers).post(r.saveUser,o.authenticate("local",{successRedirect:"/",failureRedirect:"/welcome"})),e.route("/api/users/logged").get(function(e,o){o.json(n)}),e.use("/api/burn",t.curseOfAlexandria),e.use("/api/purge",r.genocide),e.route("/api/library").get(t.library)}},function(e,o){e.exports=require("passport-local")},function(e,o,n){"use strict";function t(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(o,"__esModule",{value:!0}),o.updatePassword=o.saveUser=o.updateProfile=o.viewUsers=o.genocide=o.allUsers=void 0;var r=n(6),u=t(r),s=n(7),a=t(s);o.allUsers=function(e,o){u.default.find({},function(e,n){o.json(n)})},o.genocide=function(e,o){u.default.remove({},function(e,n){console.log("All users deleted..."),o.json(n)})},o.viewUsers=function(e,o){u.default.find({},function(e,n){e&&console.error(e),n&&o.json(n)})},o.updateProfile=function(e,o){var n=e.params.user,t=JSON.parse(decodeURIComponent(e.params.data));u.default.findOne({username:n},function(e,n){e&&console.error(e),n&&(t.username&&(n.username=t.username),t.location&&(n.location=t.location),n.save(function(e,t){o.json("Your information has been updated. \nNew username: "+n.username+"\nNew location: "+n.location)}))})},o.saveUser=function(e,o,n){var t=e.body;u.default.findOne({username:t.username},function(e,r){e&&console.error(e),r?o.json("This username is taken. Please choose another."):a.default.hash(t.password,10,function(e,o){new u.default({username:t.username,password:o,location:t.location}).save(function(e,o){return e&&console.error(e),console.log(t.username+" successfully signed up. Logging in."),n()})})})},o.updatePassword=function(e,o){var n=e.params.user,t=JSON.parse(decodeURIComponent(e.params.data));u.default.findOne({username:n},function(e,n){e&&console.error(e),n?a.default.compare(t.currentPassword,n.password,function(e,r){r&&a.default.hash(t.newPassword,10,function(e,t){n.password=t,n.save(function(e,n){e&&console.error(e),o.json("Password successfully changed.")})})}):o.json("There was a problem changing your password. Please try again.")})}},function(e,o,n){"use strict";Object.defineProperty(o,"__esModule",{value:!0}),o.searchSubmit=void 0;var t=n(23);o.searchSubmit=function(e,o){(0,t.f)("GET","https://openlibrary.org/search.json?q="+e.params.s,function(e){for(var n=[],t=0;t<20;t++){var r=e.docs[t],u=void 0;u=r.author_name?1===r.author_name.length?r.author_name[0]:2===r.author_name.length?r.author_name.join(" and "):r.author_name.length>2?r.author_name[0]+", "+r.author_name[1]+", et al.":"Unlisted":"Unlisted";var s=void 0;s=r.title?r.title:"Unlisted Title";var a=void 0;a=r.first_publish_year?r.first_publish_year:0;var i=void 0;i=r.cover_edition_key?r.cover_edition_key:null;var l=void 0;r.key&&(l=r.key,l=l.split(""),l.splice(0,7),l=l.join(""));var c={author:u,title:s,publication:a,cover:i,olkey:l};if(c.cover&&n.push(c),t===e.docs.length-1)break}o.json(n)})}},function(e,o,n){"use strict";function t(e){return function(){var o=e.apply(this,arguments);return new Promise(function(e,n){function t(r,u){try{var s=o[r](u),a=s.value}catch(e){return void n(e)}if(!s.done)return Promise.resolve(a).then(function(e){t("next",e)},function(e){t("throw",e)});e(a)}return t("next")})}}Object.defineProperty(o,"__esModule",{value:!0});o.f=function(){var e=t(regeneratorRuntime.mark(function e(o,n,t,r){var u,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch(n,{method:o});case 3:return u=e.sent,e.next=6,u.json();case 6:s=e.sent,t(s),e.next=13;break;case 10:return e.prev=10,e.t0=e.catch(0),e.abrupt("return",e.t0);case 13:return e.prev=13,r&&r(),e.finish(13);case 16:case"end":return e.stop()}},e,void 0,[[0,10,13,16]])}));return function(o,n,t,r){return e.apply(this,arguments)}}()},function(e,o){e.exports=require("http")},function(e,o){e.exports=require("socket.io")},function(e,o,n){"use strict";Object.defineProperty(o,"__esModule",{value:!0});var t=n(4),r=function(e){return e&&e.__esModule?e:{default:e}}(t),u=(n(3),function(e){e.on("connection",function(o){console.log("Web Sockets connected."),o.on("librarian",function(e){setInterval(function(){r.default.find({owner:[e[1]]},function(e,n){e&&console.error(e),n&&o.emit("librarian",[n,null,null,null,null])}),r.default.find({owner:{$ne:[e[1]]},requested:!1},function(e,n){e&&console.error(e),n&&o.emit("librarian",[null,n,null,null,null])}),r.default.find({requested:!0},function(e,n){e&&console.error(e),n&&o.emit("librarian",[null,null,n,null,null])}),r.default.find({requested:!0,requestor:e[1]},function(e,n){e&&console.error(e),n&&o.emit("librarian",[null,null,null,n,null])}),r.default.find({requested:!0,owner:e[1]},function(e,n){e&&console.error(e),n&&o.emit("librarian",[null,null,null,null,n])})},e[0])}),e.on("disconnect",function(){console.log("Web Sockets disconnected.")})})});o.default=u},function(e,o){e.exports=require("connect-mongo")}]);