!function(e){function o(t){if(n[t])return n[t].exports;var r=n[t]={i:t,l:!1,exports:{}};return e[t].call(r.exports,r,r.exports,o),r.l=!0,r.exports}var n={};o.m=e,o.c=n,o.d=function(e,n,t){o.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:t})},o.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(n,"a",n),n},o.o=function(e,o){return Object.prototype.hasOwnProperty.call(e,o)},o.p="",o(o.s=9)}([function(e,o){e.exports=require("dotenv")},function(e,o){e.exports=require("mongoose")},function(e,o,n){"use strict";Object.defineProperty(o,"__esModule",{value:!0}),o.changeBookOwner=o.removeBook=o.saveBook=o.denyRequest=o.approveRequest=o.cancelRequest=o.requestBook=o.sternGaze=o.curseOfAlexandria=o.otherShelves=o.userShelves=o.library=void 0;var t=n(5),r=function(e){return e&&e.__esModule?e:{default:e}}(t);o.library=function(e,o){r.default.find({},function(e,n){e&&console.error(e),n&&o.json(n)})},o.userShelves=function(e,o){var n=e.params.user;r.default.find({owner:n},function(e,n){e&&console.error(e),n?o.json(n):o.json("Nope, nothing")})},o.otherShelves=function(e,o){var n=e.params.user;r.default.find({owner:{$ne:n}},function(e,n){e&&console.error(e),n?o.json(n):o.json("Nope, you own the whole library.")})},o.curseOfAlexandria=function(e,o){r.default.remove({},function(e,n){console.log("All books deleted..."),o.json(n)})},o.sternGaze=function(e,o){o.on(e,function(e){setInterval(function(){r.default.find({},function(e,n){o.emit(n)})},e)})},o.requestBook=function(e,o){var n=e.params.user,t=JSON.parse(decodeURIComponent(e.params.data));r.default.findOneAndUpdate({olkey:t.olkey},{requested:!0,requestor:n},function(e,n){e&&console.error(e),n&&o.json("Book requested.")})},o.cancelRequest=function(e,o){var n=e.params.user,t=JSON.parse(decodeURIComponent(e.params.data));r.default.findOneAndUpdate({olkey:t.olkey,requestor:n,requested:!0},{requested:!1,requestor:""},function(e,n){e&&console.error(e),n&&o.json("Request for book with olkey "+t.olkey+" cancelled.")})},o.approveRequest=function(e,o){var n=e.params.user,t=JSON.parse(decodeURIComponent(e.params.data));r.default.findOne({olkey:t.olkey,owner:n,requested:!0},function(e,n){e&&console.error(e),n&&(console.log("Before",n),n.owner=n.requestor,n.requestor="",n.requested=!1,console.log("After",n),n.save(function(e,n){console.log("Saved",n),o.json("You have successfully swapped a book!")}))})},o.denyRequest=function(e,o){var n=e.params.user,t=JSON.parse(decodeURIComponent(e.params.data));r.default.findOneAndUpdate({olkey:t.olkey,owner:n,requested:!0},{requested:!1,requestor:""},function(e,n){e&&console.error(e),n&&o.json("Request for book with olkey "+t.olkey+" denied.")})},o.saveBook=function(e,o){var n=e.params.user,t=JSON.parse(decodeURIComponent(e.params.data));r.default.findOne({username:n,olkey:t.olkey},function(e,u){if(e&&console.error(e),u)o.json("This book is already in the database");else{new r.default({author:t.author,title:t.title,publication:t.publication,cover:t.cover,olkey:t.olkey,owner:n}).save(function(e,t){e&&console.error(e),o.json("This book has been saved! Praise Jesus! It is owned by "+n+"!")})}})},o.removeBook=function(e,o){var n=e.params.user,t=JSON.parse(decodeURIComponent(e.params.data));console.log(t),r.default.remove({owner:n,olkey:t.olkey},function(e,n){e&&console.error(e),n&&(console.log(n+" has been deleted."),o.json(n+" has been deleted."))})},o.changeBookOwner=function(e,o){r.default.find({owner:e},function(e,n){console.log("Updating book ownership to new username..."),e&&console.error(e),n&&n.map(function(e){e.owner=o,e.save(function(e,o){e&&console.error(e),console.log("Book ownership updated:",o)})})})}},function(e,o){e.exports=require("babel-polyfill")},function(e,o){e.exports=require("passport")},function(e,o,n){"use strict";Object.defineProperty(o,"__esModule",{value:!0});var t=n(1),r=function(e){return e&&e.__esModule?e:{default:e}}(t),u=r.default.Schema,s=new u({author:String,cover:String,olkey:String,owner:String,publication:Number,requested:{default:!1,type:Boolean},requestor:String,title:String});o.default=r.default.model("Book",s)},function(e,o,n){"use strict";function t(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(o,"__esModule",{value:!0}),o.authConfig=void 0;var r=n(7),u=t(r),s=n(4),a=(t(s),n(21)),i=n(8),l=t(i);o.authConfig=function(e){e.use(new a.Strategy(function(e,o,n){u.default.findOne({username:e},function(e,t){return e?n(e):t?void l.default.compare(o,t.password,function(e,o){return o?n(null,t):(console.log("Bad password"),n(null,!1))}):(console.log("No such user exists."),n(null,!1))})})),e.serializeUser(function(e,o){o(null,e.id)}),e.deserializeUser(function(e,o){u.default.findById(e,function(e,n){o(e,n)})})}},function(e,o,n){"use strict";function t(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(o,"__esModule",{value:!0});var r=n(20),u=t(r),s=n(1),a=t(s),i=a.default.Schema,l=new i({created:{type:Date,required:!0,default:new Date},location:{match:u.default.location,minlength:1,required:!0,type:String},password:{match:u.default.password,minlength:8,required:!0,type:String},username:{index:{unique:!0},match:u.default.username,minlength:1,required:!0,type:String}});o.default=a.default.model("User",l)},function(e,o){e.exports=require("bcrypt")},function(e,o,n){n(3),e.exports=n(10)},function(e,o,n){"use strict";function t(e){return e&&e.__esModule?e:{default:e}}n(3);var r=n(11),u=t(r);n(12);var s=n(13),a=t(s),i=n(0),l=t(i),c=n(14),d=t(c),f=n(15),p=t(f),v=n(1),m=t(v),h=n(16),g=t(h),y=n(4),w=t(y),q=n(17),b=t(q),k=n(18),_=t(k),O=n(19),j=n(6),x=n(25),S=t(x),R=n(26),U=t(R),P=n(27),N=t(P);u.default.polyfill();var B=(0,a.default)(),M=process.cwd();l.default.load();B.use((0,d.default)("tiny")),B.use((0,p.default)()),B.use("/js",a.default.static(M+"/dist/js")),B.use("/styles",a.default.static(M+"/dist/styles")),B.use("/img",a.default.static(M+"/dist/img"));var A=m.default.connection;m.default.Promise=u.default,m.default.connect(process.env.MONGO_URI,{useMongoClient:!0},function(e,o){e?console.error("Failed to connect to database!"):console.log("Connected to database.")});var C=n(28)(g.default);B.use(b.default.urlencoded({extended:!1})),B.use((0,_.default)());var I={secret:process.env.SECRET,resave:!1,saveUninitialized:!1,cookie:{path:"/",httpOnly:!1,maxAge:18e5},store:new C({mongooseConnection:A},function(e){console.log(e)}),name:"id"};B.set("trust proxy",1),I.cookie.secure=!0,I.cookie.httpOnly=!0,B.use((0,g.default)(I)),B.use(w.default.initialize()),B.use(w.default.session()),(0,j.authConfig)(w.default),(0,O.routes)(B,w.default);var z=S.default.createServer(B),J=(0,U.default)(z);(0,N.default)(J);var L=process.env.PORT;z.listen(L,function(){console.log("Server is listening on port",L+".")})},function(e,o){e.exports=require("es6-promise")},function(e,o){e.exports=require("isomorphic-fetch")},function(e,o){e.exports=require("express")},function(e,o){e.exports=require("morgan")},function(e,o){e.exports=require("compression")},function(e,o){e.exports=require("express-session")},function(e,o){e.exports=require("body-parser")},function(e,o){e.exports=require("cookie-parser")},function(e,o,n){"use strict";Object.defineProperty(o,"__esModule",{value:!0}),o.routes=void 0;var t=n(0),r=function(e){return e&&e.__esModule?e:{default:e}}(t),u=n(2),s=(n(6),n(22)),a=n(23),i=process.cwd();r.default.load();o.routes=function(e,o){e.use("*",function(e,o,n){"https"!==e.headers["x-forwarded-proto"]?(console.log("Redirecting to",process.env.APP_URL+e.url),o.redirect(process.env.APP_URL+e.url)):n()}),e.route("/welcome/jsValidate/:data").post(s.jsValidate),e.route("/welcome").get(function(e,o){o.sendFile(i+"/dist/welcome.html")}).post(o.authenticate("local",{successRedirect:"/",failureRedirect:"/welcome"}));var n=void 0,t=function(e,o,t){if(e.isAuthenticated())return n=e.user.username,t();o.redirect("/welcome")};e.route("/").get(t,function(e,o){o.sendFile(i+"/dist/index.html")}),e.route("/logout").get(t,function(e,o){e.logout(),o.redirect("/welcome")}),e.route("/api/search/:s").post(a.searchSubmit),e.route("/api/:user/request/:data").post(u.requestBook),e.route("/api/:user/cancelRequest/:data").post(u.cancelRequest),e.route("/api/:user/denyRequest/:data").post(u.denyRequest),e.route("/api/:user/approveRequest/:data").post(u.approveRequest),e.route("/api/:user/update-profile/:data").post(s.updateProfile),e.route("/api/:user/update-password/:data").post(s.updatePassword),e.route("/api/:user/save/:data").post(u.saveBook).delete(u.removeBook),e.route("/api/:user/userBooks").get(u.userShelves),e.route("/api/:user/otherBooks").get(u.otherShelves),e.route("/api/users").get(s.viewUsers).post(s.saveUser,o.authenticate("local",{successRedirect:"/",failureRedirect:"/welcome"})),e.route("/api/users/logged").get(function(e,o){o.json(n)}),e.route("/api/:user/location").get(s.getLocation)}},function(e,o,n){"use strict";Object.defineProperty(o,"__esModule",{value:!0});var t={location:/^[a-zA-Z\,\-\.\ ]{1,100}$/,password:/(?=.*[a-zA-Z]+)(?=.*[0-9]+)(?=.*[^a-zA-Z0-9]+).{8,}/,username:/^[A-Za-z0-9\-\.\,\ ]{1,40}$/};o.default=t},function(e,o){e.exports=require("passport-local")},function(e,o,n){"use strict";function t(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(o,"__esModule",{value:!0}),o.updatePassword=o.updateProfile=o.saveUser=o.getLocation=o.jsValidate=o.genocide=o.viewUsers=void 0;var r=n(0),u=t(r),s=n(7),a=t(s),i=n(8),l=t(i),c=n(2);process.cwd();u.default.load();o.viewUsers=function(e,o){a.default.find({},function(e,n){e&&console.error(e),n&&o.json(n)})},o.genocide=function(e,o){a.default.remove({},function(e,n){e&&console.error(e),n&&(console.log("All users deleted..."),o.json("All users deleted..."))})},o.jsValidate=function(e,o){var n=JSON.parse(decodeURIComponent(e.params.data)),t=n.username,r=n.password;a.default.findOne({username:t},function(e,n){e&&console.error(e),r?n?l.default.compare(r,n.password,function(e,n){n?o.json("OK"):o.json("NO")}):o.json("NO"):n?o.json("NO"):o.json("OK")})},o.getLocation=function(e,o){var n=e.params.user;a.default.findOne({username:n},function(e,n){e&&console.error(e),n&&o.json(n.location)})},o.saveUser=function(e,o,n){var t=e.body;a.default.findOne({username:t.username},function(e,r){e&&console.error(e),r?o.json("NO"):l.default.hash(t.password,10,function(e,o){new a.default({username:t.username,password:o,location:t.location}).save(function(e,o){return e&&console.error(e),console.log(t.username+" successfully signed up. Logging in."),n()})})})},o.updateProfile=function(e,o){var n=e.params.user,t=JSON.parse(decodeURIComponent(e.params.data));t.username&&a.default.findOne({username:t.username},function(e,r){e&&console.error(e),r?o.json("NO"):a.default.findOneAndUpdate({username:n},{username:t.username},function(e,r){e&&console.error(e),r&&((0,c.changeBookOwner)(n,t.username),o.json("OK"))})}),t.location&&a.default.findOneAndUpdate({username:n},{location:t.location},function(e,n){e&&console.error(e),n&&(console.log(n),o.json("New location:"+n.location))})},o.updatePassword=function(e,o){var n=e.params.user,t=JSON.parse(decodeURIComponent(e.params.data));a.default.findOne({username:n},function(e,n){e&&console.error(e),n?l.default.compare(t.currentPassword,n.password,function(e,r){r?l.default.hash(t.newPassword,10,function(e,t){n.password=t,n.save(function(e,n){e&&console.error(e),o.json("OK")})}):o.json("NO")}):o.json("NO")})}},function(e,o,n){"use strict";Object.defineProperty(o,"__esModule",{value:!0}),o.searchSubmit=void 0;var t=n(24);o.searchSubmit=function(e,o){(0,t.f)("GET","https://openlibrary.org/search.json?q="+e.params.s,function(e){for(var n=[],t=0;t<20;t++){var r=e.docs[t],u=void 0;u=r.author_name?1===r.author_name.length?r.author_name[0]:2===r.author_name.length?r.author_name.join(" and "):r.author_name.length>2?r.author_name[0]+", "+r.author_name[1]+", et al.":"Unlisted":"Unlisted";var s=void 0;s=r.title?r.title:"Unlisted Title";var a=void 0;a=r.first_publish_year?r.first_publish_year:0;var i=void 0;i=r.cover_edition_key?r.cover_edition_key:null;var l=void 0;r.key&&(l=r.key,l=l.split(""),l.splice(0,7),l=l.join(""));var c={author:u,title:s,publication:a,cover:i,olkey:l};if(c.cover&&n.push(c),t===e.docs.length-1)break}o.json(n)})}},function(e,o,n){"use strict";function t(e){return function(){var o=e.apply(this,arguments);return new Promise(function(e,n){function t(r,u){try{var s=o[r](u),a=s.value}catch(e){return void n(e)}if(!s.done)return Promise.resolve(a).then(function(e){t("next",e)},function(e){t("throw",e)});e(a)}return t("next")})}}Object.defineProperty(o,"__esModule",{value:!0});o.f=function(){var e=t(regeneratorRuntime.mark(function e(o,n,t,r){var u,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch(n,{method:o});case 3:return u=e.sent,e.next=6,u.json();case 6:s=e.sent,t(s),e.next=13;break;case 10:return e.prev=10,e.t0=e.catch(0),e.abrupt("return",e.t0);case 13:return e.prev=13,r&&r(),e.finish(13);case 16:case"end":return e.stop()}},e,void 0,[[0,10,13,16]])}));return function(o,n,t,r){return e.apply(this,arguments)}}(),o.uniq=function(e){return Array.from(new Set(e))}},function(e,o){e.exports=require("http")},function(e,o){e.exports=require("socket.io")},function(e,o,n){"use strict";Object.defineProperty(o,"__esModule",{value:!0});var t=n(5),r=function(e){return e&&e.__esModule?e:{default:e}}(t),u=(n(2),function(e){e.on("connection",function(o){console.log("Web Sockets connected."),o.on("librarian",function(e){setInterval(function(){r.default.find({owner:[e[1]]},function(e,n){e&&console.error(e),n&&o.emit("librarian",[n,null,null,null,null])}),r.default.find({owner:{$ne:[e[1]]},requested:!1},function(e,n){e&&console.error(e),n&&o.emit("librarian",[null,n,null,null,null])}),r.default.find({requested:!0},function(e,n){e&&console.error(e),n&&o.emit("librarian",[null,null,n,null,null])}),r.default.find({requested:!0,requestor:e[1]},function(e,n){e&&console.error(e),n&&o.emit("librarian",[null,null,null,n,null])}),r.default.find({requested:!0,owner:e[1]},function(e,n){e&&console.error(e),n&&o.emit("librarian",[null,null,null,null,n])})},e[0])}),e.on("disconnect",function(){console.log("Web Sockets disconnected.")})})});o.default=u},function(e,o){e.exports=require("connect-mongo")}]);